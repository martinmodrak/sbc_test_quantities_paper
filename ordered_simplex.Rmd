---
title: "Ordered simplex"
output: 
  html_document:
    toc: TRUE
abstract: "This R Markdown document runs the simulations and recreates all the figures used in TODO 'Simulation-Based Calibration Checking for Bayesian Computation: The Choice of Test Quantities Shapes Sensitivity'"
---

# Setting up

The examples are run using the [SBC](https://hyunjimoon.github.io/SBC/) R package.  - consult
the [Getting Started with SBC](https://hyunjimoon.github.io/SBC/articles/SBC.html) vignette for basics of the package. 

```{r setup, message=FALSE,warning=FALSE, results="hide"}
knitr::opts_chunk$set(cache = TRUE)
library(SBC)
library(ggplot2)
library(patchwork)
library(tidyverse)
library(cmdstanr)
theme_set(cowplot::theme_cowplot())

options(mc.cores = parallel::detectCores(), SBC.min_chunk_size = 5)

library(future)
plan(multisession)

cache_dir <- "./_SBC_cache_ordered_simplex"

fig_dir <- "./_figs" 

if(!dir.exists(cache_dir)) {
  dir.create(cache_dir)
}
if(!dir.exists(fig_dir)) {
  dir.create(fig_dir)
}

devtools::load_all()

hist_plot_width <- 8
hist_plot_height <- 4


```


```{r}
generate_one_dataset <- function(N, K, prior_alpha = 1) {
  x_raw <- MCMCpack::rdirichlet(1, alpha = rep(prior_alpha, K))
  x <- sort(x_raw)
  observed <- as.integer(rmultinom(1, size = N, prob = x))
  
  list(
    variables = list(x = x),
    generated = list(K = K, observed = observed, prior_alpha = rep(prior_alpha, K))
  )
}

set.seed(56823974)
datasets_flat <- generate_datasets(
    SBC_generator_function(generate_one_dataset, N = 20, K = 4),
    n_sims = 1000)

datasets_conc <- generate_datasets(
    SBC_generator_function(generate_one_dataset, N = 10, K = 4, prior_alpha = 3),
    n_sims = 1000)


dq <- derived_quantities(log_lik = dmultinom(observed, prob = x, log = TRUE))
```


# Gamma

```{r}
m_gamma <- cmdstan_model("stan/ordered_simplex_gamma.stan")
backend_gamma <- SBC_backend_cmdstan_sample(m_gamma, chains = 2)
```

```{r}
res_gamma_flat <- compute_SBC(datasets_flat, backend_gamma, keep_fits = FALSE, dquants = dq,
                              cache_location = file.path(cache_dir, "ordered_simplex_gamma_flat.rds"),
                              cache_mode = "results")
  
plot_rank_hist(res_gamma_flat)
plot_ecdf_diff(res_gamma_flat)

plot_sim_estimated(res_gamma_flat, alpha = 0.2)
```

```{r}
res_gamma_conc <- compute_SBC(datasets_conc, backend_gamma, keep_fits = FALSE, dquants = dq,
                              cache_location = file.path(cache_dir, "ordered_simplex_gamma_conc.rds"),
                              cache_mode = "results")
  
plot_rank_hist(res_gamma_conc)
plot_ecdf_diff(res_gamma_conc)

plot_sim_estimated(res_gamma_conc, alpha = 0.2)
```

# Min

```{r}
m_min <- cmdstan_model("stan/ordered_simplex_min.stan")
backend_min <- SBC_backend_cmdstan_sample(m_min, chains = 2)
```


```{r}
res_min_flat <- compute_SBC(datasets_flat, backend_min, keep_fits = FALSE, dquants = dq,
                              cache_location = file.path(cache_dir, "ordered_simplex_min_flat.rds"),
                              cache_mode = "results")
  
plot_rank_hist(res_min_flat)
plot_ecdf_diff(res_min_flat)

plot_sim_estimated(res_min_flat, alpha = 0.2)
```

```{r}
res_min_conc <- compute_SBC(datasets_conc, backend_min, keep_fits = FALSE, dquants = dq,
                              cache_location = file.path(cache_dir, "ordered_simplex_min_conc.rds"),
                              cache_mode = "results")
  
plot_rank_hist(res_min_conc)
plot_ecdf_diff(res_min_conc)

plot_sim_estimated(res_min_conc, alpha = 0.2)
```




# Min nodens

```{r}
m_min_nodens <- cmdstan_model("stan/ordered_simplex_min_nodens.stan")
backend_min_nodens <- SBC_backend_cmdstan_sample(m_min_nodens, chains = 2)
```


```{r}
res_min_nodens_flat <- compute_SBC(datasets_flat, backend_min_nodens, keep_fits = FALSE, dquants = dq,
                              cache_location = file.path(cache_dir, "ordered_simplex_min_nodens_flat.rds"),
                              cache_mode = "results")
  
plot_rank_hist(res_min_nodens_flat)
plot_ecdf_diff(res_min_nodens_flat)

plot_sim_estimated(res_min_nodens_flat, alpha = 0.2)
```

```{r}
res_min_nodens_conc <- compute_SBC(datasets_conc, backend_min_nodens, keep_fits = FALSE, dquants = dq,
                              cache_location = file.path(cache_dir, "ordered_simplex_min_nodens_conc.rds"),
                              cache_mode = "results")
  
plot_rank_hist(res_min_nodens_conc)
plot_ecdf_diff(res_min_nodens_conc)

plot_sim_estimated(res_min_nodens_conc, alpha = 0.2)
```




# Bad

```{r}
m_bad <- cmdstan_model("stan/ordered_simplex_bad.stan")
backend_bad <- SBC_backend_cmdstan_sample(m_bad, chains = 2)
```

```{r}
res1bad <- m_bad$sample(datasets_flat$generated[[1]], chains = 4, refresh = 0)
# res1rvars <- posterior::as_draws_rvars(res1bad$draws())
# res1_uncons <- posterior::draws_rvars(y1 = log(res1rvars$y[1]),
#                                       y2 = log(res1rvars$y[2] - res1rvars$y[1]),
#                                       y3 = log(res1rvars$y[3] - res1rvars$y[2]))
# bayesplot::mcmc_pairs(res1_uncons)
#bayesplot::mcmc_pairs(res1bad$draws()
```
```{r}
res1min <- m_min$sample(datasets_flat$generated[[1]], chains = 4, refresh = 0)
bayesplot::mcmc_pairs(res1min$draws("y"), transformations = "qlogis")
```


```{r}
res_bad_flat <- compute_SBC(datasets_flat, backend_bad, keep_fits = FALSE, dquants = dq,
                              cache_location = file.path(cache_dir, "ordered_simplex_bad_flat.rds"),
                              cache_mode = "results")
  
plot_rank_hist(res_bad_flat)
plot_ecdf_diff(res_bad_flat)

plot_sim_estimated(res_bad_flat, alpha = 0.2)
```

```{r}
res_bad_conc <- compute_SBC(datasets_conc, backend_bad, keep_fits = FALSE, dquants = dq,
                              cache_location = file.path(cache_dir, "ordered_simplex_bad_conc.rds"),
                              cache_mode = "results")
  
plot_rank_hist(res_bad_conc)
plot_ecdf_diff(res_bad_conc)

plot_sim_estimated(res_bad_conc, alpha = 0.2)
```

# Lin

```{r}
m_lin <- cmdstan_model("stan/ordered_simplex_lin.stan")
backend_lin <- SBC_backend_cmdstan_sample(m_lin, chains = 2)
```


```{r}
res_lin_flat <- compute_SBC(datasets_flat, backend_lin, keep_fits = FALSE, dquants = dq,
                              cache_location = file.path(cache_dir, "ordered_simplex_lin_flat.rds"),
                              cache_mode = "results")
  
plot_rank_hist(res_lin_flat)
plot_ecdf_diff(res_lin_flat)

plot_sim_estimated(res_lin_flat, alpha = 0.2)
```

```{r}
res_lin_conc <- compute_SBC(datasets_conc, backend_lin, keep_fits = FALSE, dquants = dq,
                              cache_location = file.path(cache_dir, "ordered_simplex_lin_conc.rds"),
                              cache_mode = "results")
  
plot_rank_hist(res_lin_conc)
plot_ecdf_diff(res_lin_conc)

plot_sim_estimated(res_lin_conc, alpha = 0.2)
```


# Performance

```{r}
rbind(
  res_bad_flat$backend_diagnostics %>% mutate(model = "softmax"),
  res_min_flat$backend_diagnostics %>% mutate(model = "min"),
  res_min_nodens_flat$backend_diagnostics %>% mutate(model = "min_nodens"),
  res_gamma_flat$backend_diagnostics %>% mutate(model = "gamma")) %>%
  ggplot(aes(x = max_chain_time)) + geom_histogram() + facet_wrap(~ model, ncol = 1)

mean(res_bad_flat$backend_diagnostics$max_chain_time)
mean(res_min_flat$backend_diagnostics$max_chain_time)
mean(res_min_nodens_flat$backend_diagnostics$max_chain_time)
mean(res_gamma_flat$backend_diagnostics$max_chain_time)
```

# Derivation - min

Here, we start with unordered bounded vector $\mathbf{u} \in \mathbb{R}^{K - 1}, 0 < u_i < 1$ (which is a primitive in Stan). We notice that the minimal element of the simplex needs to satisfy $x_1 < \frac{1}{K}$, so we set $x_1 = \frac{u_1}{K}$. We further note that given $x_1$, if we set $\mathbf{x}^\prime \in \mathbb{R^{K-1}}, x^\prime_i = \frac{x_{i + 1} - x_1}{1 - Kx_1}$ then $\mathbf{x}^\prime \in OrdSimplex_{K - 1}$ giving us a recursive formula for the transformation:

$$
b_1 = 0, r_1 = 1 \\
\text{for } 1 \leq i < K : c_i =  x_i = b_i + r_i \frac{u_i}{K + 1 - i}, b_{i + 1} = x_i, r_{i + 1} = r_{i}( 1 - u_i) \\
x_k = b_k + r_k = 1 - \sum_i^{K - 1}x_i
$$


# Derivation - softmax

$$
s = 1 + \sum_i^{K-1} \exp v_i \\
x_1 = \frac{1}{s}, x_k = \frac{\exp v_{k - 1}}{s} \\
k >1: \\

\frac{\partial x_k}{\partial v_{k - 1}} = \frac{\exp v_{k-1}}{s} - \frac{\exp^2 v_{k-1}}{s^2} = \frac{s \exp v_{k-1} - \exp^2 v_{k-1}}{s^2} = \frac{\exp v_{k-1}(s - \exp v_{k-1})}{s^2} \\
j \neq k-1: \frac{\partial x_k}{\partial v_{j}} = -\frac{\exp (v_{k -1 } + v_j)}{s^2}
$$

Use a $K-1$ dimensional diagonal matrix $\mathbf{D}$ where $\mathbf{D}_{i, i} = \frac{\exp y_i}{s^2}$

$$
\mathbf{J} = \left(
\mathbf D
\begin{pmatrix}
- \exp v_1 & \ldots &  - \exp v_{K-1} \\
\vdots & \ddots & \vdots \\
- \exp v_1 & \ldots &  - \exp v_{K-1} \\
\end{pmatrix} + s\mathbf{I}_{K-1} \right) \\
c_k = -\exp v_k, r_k = 1   \\
\mathbf{J} = \mathbf{D}\left(\mathbf{cr} + s\mathbf{I}_{K-1}\right)
$$


by Matrix determinant lemma we have for invertible matrix $\mathbf{X}$ and any column vector $\mathbf{c}$ and row vector $\mathbf{r}$ that $\det(\mathbf{cr} + \mathbf{X}) =\det(\mathbf{X})( 1 + r\mathbf{X}^{-1}c)$ and thus

Since $\mathbf{rc} = \sum_i^{K - 1}(-\exp v_i) = 1 - s$ we have:

$$
\det( \mathbf{cr} + s\mathbf{I}_{K-1}) = \left(1 + \frac{1}{s}\mathbf{rc} \right) s^{K-1} = \left(1 + \frac{1 - s}{s} \right) s^{K-1} = s^{K - 2} \\
$$
Since $\det \mathbf{D} = \frac{\exp \sum_i^{K - 1} y_i}{s^{2(K - 1)}}$ we finally have

$$
\det \mathbf{J} = \det \mathbf{D} \det (\mathbf{cr} + s\mathbf{I}_{K-1}) =   \frac{\exp \sum_i^{K - 1} v_i}{s^{K}}
$$

Version with error:

$$
\det \mathbf{J} = \det \mathbf{D} \det (\mathbf{cr} + s\mathbf{I}_{K-1}) = \frac{\exp \sum_i^{K - 1} v_i}{s^{K - 1}}
$$

# Derivation - lin

\frac{\partial x_1}{\partial y_i} = -s^{-2},  


$$
s = K + \sum_i^{K-1} y_i \\
x_1 = \frac{1}{s}, x_k = \frac{1 + y_{k - 1}}{s} \\
k >1: \\

\frac{\partial x_k}{\partial y_{k - 1}} = \frac{1}{s} - \frac{1 + y_{k-1}}{s^2} = \frac{s - 1 - y_{k-1}}{s^2} \\
j \neq k_{-1}: \frac{\partial x_k}{\partial y_{j}} = -\frac{1 + y_{k - 1}}{s^2}
$$

$$
J = \frac{1}{s^2}\left(\begin{pmatrix}
- 1 - y_{1} & \ldots &  -1 - y_{K-1} \\
\vdots & \ddots & \vdots \\
- 1 - y_{1} & \ldots &  -1 - y_{K-1} \\
\end{pmatrix} + s\mathbf{I}_{K-1} \right) \\
c_k = - 1 - y_k, r_k = 1   \\
J = \frac{1}{s^2}\left(\mathbf{cr} + s\mathbf{I}_{K-1}\right)
$$

by Matrix determinant lemma we have for invertible matrix $\mathbf{X}$ and any column vector $\mathbf{c}$ and row vector $\mathbf{r}$ that $\det(\mathbf{cr} + \mathbf{X}) =\det(\mathbf{X})( 1 + r\mathbf{X}^{-1}c)$ and thus

Since $\mathbf{rc} = \sum_i^{K - 1}(-1 - y) = 1 - s$ we have:

$$
\det \frac{J}{s^2} = \left(1 + \frac{1}{s}\mathbf{rc} \right) s^{K-1} = \left(1 + \frac{1 - s}{s} \right) s^{K-1} = s^{K - 2} \\
$$

(the error is below)

$$
\det J = \frac{1}{s^{2(K - 1)}} \det \frac{J}{s^2} = \frac{1}{s^{K - 1}}
$$
correct version:

$$
\det J = \frac{1}{s^{2(K - 1)}} \det \frac{J}{s^2} = \frac{1}{s^{K}}
$$
